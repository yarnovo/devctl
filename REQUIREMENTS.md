# devctl 需求文档

## 项目概述

devctl 是一个 npm 包，用于提供对 npm scripts 中的 dev 命令进行后台管理的工具。它允许开发者将 `npm run dev` 命令置于后台执行，并提供一系列管理指令来控制和监控开发服务器的运行状态。

## 目标用户

- 前端开发者
- 全栈开发者
- DevOps 工程师
- 需要管理多个开发服务器的团队

## 核心功能需求

### 1. 后台服务管理

#### 1.1 启动服务
- **功能描述**：将 `npm run dev` 置于后台执行
- **输入参数**：可选的配置参数（端口、环境变量等）
- **输出**：启动状态、进程 ID、访问地址
- **异常处理**：检测服务是否已启动，避免重复启动

#### 1.2 停止服务
- **功能描述**：优雅停止后台运行的开发服务器
- **输入参数**：无
- **输出**：停止确认信息
- **异常处理**：进程不存在时的处理

#### 1.3 重启服务
- **功能描述**：重启开发服务器
- **流程**：先停止现有服务，然后重新启动
- **输出**：重启状态信息

#### 1.4 服务状态查询
- **功能描述**：查看当前开发服务器的运行状态
- **输出信息**：
  - 运行状态（运行中/已停止）
  - 进程 ID
  - 运行时长
  - 内存使用情况
  - 访问地址

### 2. 日志管理

#### 2.1 日志输出
- **功能描述**：将开发服务器的输出重定向到日志文件
- **日志位置**：项目根目录下的 `logs/` 文件夹
- **日志格式**：
  - 时间戳
  - 日志级别
  - 消息内容
  - 来源标识

#### 2.2 实时日志查看
- **功能描述**：实时显示开发服务器的日志输出
- **交互方式**：类似 `tail -f` 的实时跟随模式
- **退出方式**：Ctrl+C 退出

#### 2.3 历史日志查看
- **功能描述**：查看历史日志文件
- **支持参数**：
  - 指定行数
  - 日期筛选
  - 关键词搜索

### 3. 配置管理

#### 3.1 配置文件支持
- **配置文件**：`devctl.config.js` 或 `devctl.config.json`
- **配置项**：
  - 默认启动命令
  - 日志级别
  - 日志文件路径
  - 端口号
  - 环境变量

#### 3.2 命令行参数
- **支持参数**：
  - `--port <number>`：指定端口号
  - `--env <environment>`：指定环境
  - `--silent`：静默模式
  - `--verbose`：详细输出模式

## 技术需求

### 1. 技术栈
- **开发语言**：TypeScript
- **运行环境**：Node.js
- **包管理**：npm
- **构建工具**：tsc 或 rollup

### 2. 依赖管理
- **核心依赖**：
  - 进程管理相关库
  - 文件系统操作库
  - 日志管理库
  - CLI 框架（如 commander.js）

### 3. 兼容性
- **Node.js 版本**：>= 14.0.0
- **操作系统**：Windows、macOS、Linux
- **包管理器**：npm、yarn、pnpm

## 命令行接口设计

### 基础命令结构
```bash
devctl <command> [options]
```

### 具体命令

#### 启动服务
```bash
devctl start [options]
devctl s [options]  # 简写
```

**选项**：
- `--port <number>`：指定端口号
- `--env <environment>`：指定环境变量
- `--silent`：静默启动
- `--config <path>`：指定配置文件路径

#### 停止服务
```bash
devctl stop
devctl down  # 别名
```

#### 重启服务
```bash
devctl restart
devctl r  # 简写
```

#### 查看状态
```bash
devctl status
devctl ps  # 别名
```

#### 查看日志
```bash
devctl logs [options]
devctl log [options]  # 别名
```

**选项**：
- `--follow`：实时跟随模式
- `--lines <number>`：显示行数
- `--since <time>`：从指定时间开始

#### 配置管理
```bash
devctl config <action> [key] [value]
```

**动作**：
- `list`：列出所有配置
- `get <key>`：获取指定配置
- `set <key> <value>`：设置配置
- `delete <key>`：删除配置

## 输出格式规范

### 1. 成功消息
- 使用绿色 ✅ 标识
- 提供必要的信息（PID、地址等）

### 2. 错误消息
- 使用红色 ❌ 标识
- 提供具体的错误原因和解决建议

### 3. 警告消息
- 使用黄色 ⚠️ 标识
- 提供注意事项

### 4. 信息消息
- 使用蓝色 ℹ️ 标识
- 提供帮助和提示信息

## 文件结构规范

### 1. 日志文件
```
logs/
├── dev.log           # 当前日志
├── dev.log.1         # 历史日志
├── dev.log.2         # 历史日志
└── dev.pid          # 进程 ID 文件
```

### 2. 配置文件
```
devctl.config.js      # 主配置文件
.devctlrc            # 用户配置文件
```

## 错误处理需求

### 1. 常见错误场景
- 端口被占用
- 权限不足
- 配置文件格式错误
- npm 命令不存在
- 进程意外终止

### 2. 错误处理策略
- 提供友好的错误信息
- 给出解决建议
- 自动恢复机制（如端口冲突时自动选择可用端口）

## 性能需求

### 1. 启动时间
- 命令响应时间 < 500ms
- 服务启动时间 < 3s

### 2. 资源占用
- 内存占用 < 50MB
- CPU 占用 < 5%（空闲状态）

### 3. 日志性能
- 支持大文件日志（> 100MB）
- 日志轮转机制

## 安全需求

### 1. 权限控制
- 只能管理当前用户启动的进程
- 配置文件权限检查

### 2. 输入验证
- 参数类型检查
- 路径安全检查
- 命令注入防护

## 未来扩展需求

### 1. 多项目支持
- 支持同时管理多个项目的开发服务器
- 项目别名功能

### 2. 插件系统
- 支持自定义插件
- 钩子函数支持

### 3. Web 界面
- 提供简单的 Web 管理界面
- 实时状态监控

### 4. 集成功能
- Git hooks 集成
- Docker 支持
- CI/CD 集成

## 验收标准

### 1. 功能完整性
- 所有核心功能正常工作
- 命令行接口按规范实现
- 错误处理覆盖主要场景

### 2. 代码质量
- TypeScript 类型覆盖率 > 95%
- 单元测试覆盖率 > 80%
- ESLint 检查通过

### 3. 文档完整性
- API 文档齐全
- 使用示例丰富
- 故障排除指南

### 4. 性能标准
- 满足性能需求指标
- 内存泄漏检测通过
- 长时间运行稳定性测试通过