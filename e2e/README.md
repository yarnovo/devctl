# devctl 端到端测试

此目录包含 devctl 工具的端到端测试，从用户角度验证完整的功能流程。

## 目录结构

```
e2e/
├── package.json          # E2E 测试包配置
├── test-project/         # 模拟的测试项目
│   ├── package.json      # 测试项目配置
│   └── server.js         # 模拟开发服务器
├── tests/                # 测试脚本
│   └── e2e.test.js      # 主要 E2E 测试脚本
└── README.md            # 本文档
```

## 测试项目说明

`test-project/` 目录包含一个模拟的 npm 项目：

- **package.json**: 定义了 `npm run dev` 脚本
- **server.js**: 模拟开发服务器，会输出日志并响应终止信号

## 测试用例

E2E 测试覆盖以下场景：

1. **基本状态查询**: 测试 `devctl status` 在无进程时的输出
2. **启动服务**: 测试 `devctl start` 启动开发服务器
3. **运行状态查询**: 测试服务运行时的状态显示
4. **重复启动保护**: 验证不能重复启动服务
5. **日志查看**: 测试 `devctl logs` 实时日志功能
6. **服务重启**: 测试 `devctl restart` 重启功能
7. **停止服务**: 测试 `devctl stop` 停止服务
8. **停止不存在服务**: 测试停止不存在服务的处理

## 运行测试

### 前置条件

1. 确保主项目已构建：
```bash
cd .. && npm run build
```

2. 安装 E2E 测试依赖：
```bash
npm run setup
```

### 运行测试

```bash
# 运行端到端测试
npm test

# 或者直接运行测试脚本
node tests/e2e.test.js
```

### 从主项目运行

```bash
cd ..
npm run test:e2e
```

## 测试特性

### 自动化程度
- 完全自动化，无需手动干预
- 自动环境清理和设置
- 自动进程管理

### 真实环境
- 使用真实的 devctl 二进制文件
- 在真实的文件系统中操作
- 启动真实的子进程

### 跨平台兼容
- 支持 Windows、macOS、Linux
- 处理不同平台的路径差异
- 兼容不同的终端环境

### 错误处理
- 测试异常情况
- 验证错误消息
- 确保资源正确清理

## 测试输出

测试运行时会显示彩色输出：

- 🧪 测试开始提示
- 📋 📊 🚀 等图标标识不同测试类型
- ✓ 绿色表示测试通过
- ✗ 红色表示测试失败
- 📊 最终统计结果

## 故障排除

### 测试失败常见原因

1. **构建问题**
   - 确保运行 `npm run build` 构建了主项目
   - 检查 `../bin/devctl.js` 文件是否存在

2. **权限问题**
   - 确保对测试目录有写权限
   - 检查能否创建和删除文件

3. **端口冲突**
   - 确保没有其他进程占用测试端口
   - 检查防火墙设置

4. **进程清理**
   - 测试失败后可能留下僵尸进程
   - 手动运行 `devctl stop` 清理

### 手动清理

如果测试异常终止，可以手动清理：

```bash
cd test-project
rm -rf logs/
../../../bin/devctl.js stop  # 如果有进程在运行
```

## 开发说明

### 添加新测试

1. 在 `tests/e2e.test.js` 中添加新的测试函数
2. 在 `runTests()` 函数中调用新测试
3. 使用 `assert()` 函数进行断言

### 测试最佳实践

1. **独立性**: 每个测试应该独立运行
2. **清理**: 确保测试后正确清理资源
3. **等待**: 给异步操作足够的时间
4. **断言**: 提供清晰的断言消息

### 调试测试

可以在测试脚本中添加调试输出：

```javascript
console.log('调试信息:', result)
```

或使用 Node.js 调试器：

```bash
node --inspect-brk tests/e2e.test.js
```